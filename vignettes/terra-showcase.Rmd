---
title: "Showcase with terra SpatRaster"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    toc: true
    theme: united
vignette: >
  %\VignetteIndexEntry{Showcase with terra SpatRaster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(fig.width = 8.83)
```

---

# Introduction

This vignette is meant to showcase that the CAST package now is able to handle
terra SpatRaster objects. Changes to the code were implemented only in the `aoa()` and
`calibrate_aoa()` function and are restricted to coercing a SpatRaster input
to a RasterStack as well as coercing the output back to SpatRaster.
Below is a minimal example based on the AOA-tutorial vignette.

```{r  message = FALSE, warning=FALSE}
library(CAST)
library(terra)
library(raster)
library(lubridate)
library(methods)
```

```{r}
predictors_sp <- stack(system.file("extdata","predictors_2012-03-25.grd",package="CAST"))
data <- get(load(system.file("extdata","Cookfarm.RData",package="CAST")))
trainDat <- data[data$altitude==-0.3&
                   year(data$Date)==2012&
                   week(data$Date)%in%c(10:12),]

library(caret)
predictors <- c("DEM","TWI","Precip_cum","cday",
                "MaxT_wrcc","Precip_wrcc","BLD",
                "Northing","Easting","NDRE.M")
set.seed(10)
model <- train(trainDat[,predictors],trainDat$VW,
               method="rf",tuneGrid=data.frame("mtry"=2),
               importance=TRUE,ntree=50,
               trControl=trainControl(method="cv",number=3))
```

From here we will coerce the Raster object to SpatRaster objects to show
that the aoa and calibrate_aoa functions work on SpatRasters as well. The 
application might not make sense on a thematic level. The example was drafted
just to show that the functions accept and return SpatRaster objects.

```{r}
predictors_terra = as(predictors_sp, "SpatRaster")
AOA <- aoa(predictors_terra, model)
class(AOA)
attributes(AOA)$aoa_stats
```

```{r}
AOA_calib <- calibrate_aoa(AOA,model,window.size = 5,length.out = 5, multiCV=TRUE,showPlot=FALSE)
class(AOA_calib$AOA)
AOA_calib$plot
```

